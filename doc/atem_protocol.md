# Documentation of the ATEM protocol
The ATEM protocol is sent between Blackmagic ATEM switchers and their clients connecting over a UDP socket on port 9910.

## Other resources
Since it is a proprietary protocol it has been very helpful to read what others have found out and documented while reverse engineering it.
I have listed the ones that have been the most useful to me.
* [Skaarhojs Arduino library](https://github.com/kasperskaarhoj/SKAARHOJ-Open-Engineering/tree/master/ArduinoLibs/ATEMbase)
* [Skaarhojs command documentation](https://www.skaarhoj.com/discover/blackmagic-atem-switcher-protocol)
* [NRKs NodeJS library](https://github.com/nrkno/tv-automation-atem-connection)
* [Documentation on openswitcher.org](https://docs.openswitcher.org/udptransport.html)
* [Documentation on node-atem](https://github.com/miyukki/node-atem/blob/master/specification.md)
* [Blackmagics camera control protocol documentation](https://documents.blackmagicdesign.com/DeveloperManuals/BlackmagicCameraControl.pdf)

# The header
The ATEM protocol header is always 12 bytes long.

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+---------+---------------------+-------------------------------+
|  flags  |         len         |           session id          |
+---------+---------------------+-------------------------------+
|         ack packet id         |         local packet id       |
+-------------------------------+-------------------------------+
|               ?               |        remote packet id       |
+-------------------------------+-------------------------------+
|                           payload...                          |
+---------------------------------------------------------------+
```

## Flags
### 0x80: ack reply
Used during [acknowledgements](#Acknowledgements).
* The [Ack packet id](#Ack packet id) must be set and indicates the id of the packet being acknowledged.
* Is set in response to a packet where the "ack request" (0x08) flag was set.
* It is also sent with the heartbeat for some reason even if an ack is not requested.
* If a packet is acknowledged, it means that all packets up to that point has been received.

### 0x40: retransmit request
Undocumented.

### 0x20: is retransmit
Used during [acknowledgements](#Acknowledgements).

### 0x10: SYN
Used during [handshake](#Handshake).
* Used for both opening and closing connections.

### 0x08: ack request
Used during [acknowledgements](#Acknowledgements).
* The [Remote packet id](#Remote packet id) must be set and indicates the id of the packet, used to acknowledge the packet by the other end.

## Length
The length part is 11 bytes long and represents the entire length of the packet including the header.
With 11 bytes, the packet length has a maximum length of 2048 bytes.

## Session id
* The first byte in the session id seems to be a flag indicating if the session id was given by the ATEM switcher.
* The session id is first randomly generated by the client, between 0x0000 and 0x7fff. When the handshake is complete, the server assigns the a new id that is between 0x8000 and 0xffff.
* In the handshake, the new session id the server assigns seems to be defined in byte 14 and 15 of the SYNACK but without the MSB set.
* ATEM can only keep a maximum of 5 connections open at a time. It uses the session id to know how many active connections it has. So having multiple sessions on a single socket does not allow for more connections unfortunately.
* Server assigned session ids are incremented by 1 for every new client connected. Wraps around to 0x0000 when reached 0x7fff in handshake, or to 0x8000 from 0xffff in header.
* The first session id assigned by the switcher is 0x0001 (or 0x8001).

## Ack packet id
Used during [acknowledgements](#Acknowledgements).
* This id is only used if the "ack reply" (0x80) flag is set.

## Local packet id
Undocumented.

## Remote packet id
Used during [acknowledgements](#Acknowledgements).
* Wraps around to 0x0000 when reached 0x7fff.



# Handshake
* It uses a threeway handshake.
* The handshake consists of the client sending a SYN packet with the opcode 0x01.
* The server responds to that SYN with a SYNACK that has the opcode 0x02, 0x03 or 0x04.
* A SYN and SYNACK packet both have the SYN flag set and are 20 bytes long including the header.
* The opcode is the first byte after the header (index 12).
* In the SYNACK, the new session id seems to be set in byte 14 and 15 but without the MSB set.
* After client receives a SYNACK, it should send back an ack, even though the ack request flag is not set.
* After the handshake is complete, the switcher will send all its data to the client and keep it up to date when states change.

## opcodes
* 0x01: Opening connection
* 0x02: Connection opened successfully
* 0x03: Connection failed to open
* 0x04: Closing connection (has been documented as a restart opcode by others, but I belive it is a closing opcode similar to how it works in the websocket protocol)
* 0x05: Connection closed



# Acknowledgements
* Acknowledgements can be required by both the server and the client.
* When an acknowledgement is required, the "ack request" (0x08) flag is set.
* If other side does not acknowledge a packet that requires an acknowledgement, it should be resent.
* ATEM resends packets fairly quickly, so they might not even have arrived at the client before ATEM resends the packet.
* Resending packets is essential since UDP does not guarantee the packet will not get lost on the way.
* When a packet is resent, the flag "is retransmit" (0x20) is set. It seems to work even if this flag is not set though.
* An acknowledge request has the "remote packet id" set. It is an incrementing number local to the session.
* An acknowledgement is done in response to an acknowlege request and sets the "ack packet id" to the value of "remote packet id".



# Heartbeat
* ATEM uses a constant heartbeat to know when a connection is lost.
* Both the server and client ping the other end about twice a second.
* The ping packet has both the "ack request" (0x08) and "ack reply" 0x80 flags set.
* The length of the packet is just 12 bytes, so there is no data sent.



# Commands
* After the handshake, all data after the header is command data.
If packet is only the length of the header, there is no command data.
* A packet can contain multiple commands concatenated together within the max payload length of the packet.
* Commands consist of a length (2 bytes), padding (2 bytes), a command name (4 bytes) and comand data (n bytes).

```
 0                   1                   2
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-------------------------------+-------------------------------+
|        command length         |            padding            |
+-------------------------------+-------------------------------+
|                         command name                          |
+---------------------------------------------------------------+
|                        command data...                        |
+---------------------------------------------------------------+
```

## Command length
* The command length is the length of the command data, including the command header.

## Command name
* The command names are 4 ASCII characters and a compiled list can be found [here](https://www.skaarhoj.com/discover/blackmagic-atem-switcher-protocol).

## Command data
* Length of command data is the same as the value of `command length`.
* Content depends on the command name.

# Timeout
* The ATEM switcher seems to kill connections after not receiving acknowledgements for about 4 seconds.
