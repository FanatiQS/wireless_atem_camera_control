# Documentation of the ATEM protocol
The ATEM protocol is sent between Blackmagic ATEM switchers and their clients connecting over a UDP socket on port 9910.

### Other resources
Since it is a proprietary protocol it has been very helpful to read what others have found out and documented while reverse engineering it.
I have listed the ones that have been the most useful to me.
* [Skaarhojs Arduino library](https://github.com/kasperskaarhoj/SKAARHOJ-Open-Engineering/tree/master/ArduinoLibs/ATEMbase)
* [Skaarhojs command documentation](https://www.skaarhoj.com/discover/blackmagic-atem-switcher-protocol)
* [NRKs NodeJS library](https://github.com/nrkno/tv-automation-atem-connection)
* [Documentation on openswitcher.org](https://docs.openswitcher.org/udptransport.html)
* [Documentation on node-atem](https://github.com/miyukki/node-atem/blob/master/specification.md)
* [Blackmagics camera control protocol documentation](https://documents.blackmagicdesign.com/DeveloperManuals/BlackmagicCameraControl.pdf)

# The header
The ATEM protocol header is always 12 bytes long.

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+---------+---------------------+-------------------------------+
|  flags  |         len         |           session id          |
+---------+---------------------+-------------------------------+
|         ack packet id         |         local packet id       |
+-------------------------------+-------------------------------+
|               ?               |        remote packet id       |
+-------------------------------+-------------------------------+
|                           payload...                          |
+---------------------------------------------------------------+
```

### Flags
###### 0x80: ack reply
Is set when the other party has acknowledged a packet that requested an ack.
It is also sent with the heartbeat for some reason even if an ack is not requested.
The packet that is acknowledged is the packet at `ack packet id`.
If a packet id is acknowledged, it means that all packets up to that point has been received.

###### 0x40: retransmit request
###### 0x20: is retransmit
###### 0x10: SYN
Used during [handshake](#Handshake).

###### 0x08: ack request
Requires an ack to be sent back that this packet has been received.
If packets are not acknowledged, they will be retransmitted with a set number of retries until disconnecting the session.

### Length
The length part is 11 bytes long and represents the entire length of the packet including the header.
With 11 bytes, the packet length has a maximum length of 2048 bytes.

### Session id
* The first byte in the session id seems to be a flag indicating if the session id was given by the ATEM switcher.
* The session id is first randomly generated by the client, between 0x0000 and 0x7fff. When the handshake is complete, the server assigns the a new id that is between 0x8000 and 0xffff.
* In the handshake, the new session id the server assigns seems to be defined in byte 14 and 15 of the SYNACK but without the MSB set.
* ATEM can only keep a maximum of 5 connections open at a time. It uses the session id to know how many active connections it has. So having multiple sessions on a single socket does not allow for more connections unfortunately.
* Server assigned session ids are incremented by 1 for every new client connected. Wraps around to 0x0000 when reached 0x7fff in handshake, or to 0x8000 from 0xffff in header.



# Handshake
* It uses a threeway handshake.
* The handshake consists of the client sending a SYN packet with the opcode 0x01.
* The server responds to that SYN with a SYNACK that has the opcode 0x02, 0x03 or 0x04.
* A SYN and SYNACK packet both have the SYN flag set and are 20 bytes long including the header.
* The opcode is the first byte after the header (index 12).
* In the SYNACK, the new session id seems to be set in byte 14 and 15 but without the MSB set.
* After client receives a SYNACK, it should send back an ack, even though the ack request flag is not set.
* After the handshake is complete, the switcher will send all its data to the client and keep it up to date when states change.

## opcodes
* 0x01: Opening connection
* 0x02: Connection opened successfully
* 0x03: Connection failed to open
* 0x04: Closing connection (has been documented as a restart opcode by others, but I belive it is a closing opcode similar to how it works in the websocket protocol)
* 0x05: Connection closed



# Commands
* After the handshake, all data after the header is command data.
If packet is only the length of the header, there is no command data.
* A packet can contain multiple commands concatenated together within the max payload length of the packet.
* Commands consist of a length (2 bytes), padding (2 bytes), a command name (4 bytes) and comand data (n bytes).

```
 0                   1                   2
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-------------------------------+-------------------------------+
|        command length         |            padding            |
+-------------------------------+-------------------------------+
|                         command name                          |
+---------------------------------------------------------------+
|                        command data...                        |
+---------------------------------------------------------------+
```

## Command length
* The command length is the length of the command data, including the command header.

## Command name
* The command names are 4 ASCII characters and a compiled list can be found [here](https://www.skaarhoj.com/discover/blackmagic-atem-switcher-protocol).

## Command data
* Length of command data is the same as the value of `command length`.
* Content depends on the command name.

# Timeout
* The ATEM switcher seems to kill connections after not receiving acknowledgements for about 4 seconds.
